//created on: Feb 12, 2016
package com.sample

//list any import classes here.
import function com.sample.DRLLogger.*;

import java.util.List;
import java.util.ArrayList;
import java.util.Map;
import java.lang.String;

import com.sample.model.ConceptSetItem;
import com.sample.model.RHSState;

import edu.pitt.dbmi.ohdsiv5.db.DrugExposure;
import edu.pitt.dbmi.ohdsiv5.db.DrugEra;
import edu.pitt.dbmi.ohdsiv5.db.Person;

/////////// 
// declare any global variables here
/////////// 
global org.hibernate.Session hibernateSession;


rule "DEBUGGING ONLY -- warfarin - ibuprofen INGREDIENT exposure"
    no-loop true
    when
      $de1 : DrugEra(drugConceptId == 1310149)
      $de2 : DrugEra(personId == $de1.getPersonId() && drugConceptId == 1177480)
      $person : Person(personId == $de1.getPersonId() && yearOfBirth <= 1951)
    then	
      System.out.println("matched drug era ids for patient (ingredient): " + $de1.getPersonId() + "; year of birth: " + $person.getYearOfBirth());
end


rule "WARFARIN - NSAID -- NO FILTER" // Concept sets exclude topical diclofenac
    no-loop true
    when
      // Warfarin ingredient drug era
      $de1 : DrugEra(drugConceptId == 1310149) 
      
      // Overlapping NSAID ingredient drug era
      $de2 : DrugEra(personId == $de1.getPersonId() && drugConceptId == 1177480 && 
                     drugEraStartDate <= $de1.getDrugEraEndDate() && drugEraEndDate >= $de1.getDrugEraStartDate())

      // Specific warfarin exposure
      $clinDrugConcept1 : ConceptSetItem(csName == 'Warfarins')
      $dexp1 : DrugExposure(personId == $de1.getPersonId() && drugExposureStartDate == $de1.getDrugEraStartDate() && drugConceptId == $clinDrugConcept1.getConceptId())
   
      // Specific NSAID exposure
      $clinDrugConcept2 : ConceptSetItem(csName == 'NSAIDs')
      $dexp2 : DrugExposure(personId == $de1.getPersonId() && drugExposureStartDate == $de2.getDrugEraStartDate() && drugConceptId == $clinDrugConcept2.getConceptId())

      $person : Person(personId == $de1.getPersonId())
    then	
      // Create a state object to be used by other LHS
      RHSState rhs = new RHSState();
      rhs.setStateName('basic concomitant exposure of warfarin and NSAID');
      rhs.setPerson($person);
      rhs.setDexp1($dexp1);
      rhs.setDexp2($dexp2);
      insert(rhs);
      
      System.out.println("matched drug EXPOSURE ids for patient (clinical drug): " + $de1.getPersonId() + "; anticoagulant: " + $clinDrugConcept1.getConceptId() + "; ibuprofen: " + $clinDrugConcept2.getConceptId());
end


rule "WARFARIN - NSAID -- test proton pump inhibitor or misoprostol"
    no-loop true
    when
        $rhs : RHSState(stateName == 'basic concomitant exposure of warfarin and NSAID')
    then	
      System.out.println("acquired RHSState: " + $rhs.getPerson().getPersonId());
end



 

